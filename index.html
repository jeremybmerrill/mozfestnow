<!DOCTYPE>
<html>
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" value="width=device-width, initial-scale=1, maximum-scale=1" />
  <script type="text/javascript" src="jquery-2.1.1.min.js" ></script>
  <style type="text/css">
    body{
      font-family: "Comic Sans MS", cursive, serif;
    }
  </style>
</head>
<body>
<h1>What's Happening at #MozFest Right Now?</h1>
<a href="#" id="rerender">what about now? (refresh)</a>
<p style="font-size: small;">Wanna make this better? Send us a <a href="https://github.com/jeremybmerrill/mozfestnow">Pull Request</a> </p>
<ul id="now">
  <li>(Your internet is slow, but the schedule is loading... Bear with me here. We'll store it locally for next time.)</li>
</ul>
  <script type="text/javascript">
    var url = "http://schedule.mozillafestival.org/api/sessions";
    // if(window.location.href.indexOf("localhost") > -1)
    //   url = "sked.json";
    window.lookbehindMinutes = 10;
    window.lookaheadMinutes = 20;
    window.lsKey = 'mozfestSked';
    window.render = function(){
      $('ul').empty();
      var now = +new Date();
      for(i=0; i<window.data.length; i++){
        var sesh = window.data[i];
        sesh.startp = Date.parse(sesh.start)
        sesh.endp = Date.parse(sesh.end)
        if(sesh.startp > (now - (window.lookbehindMinutes * 60 * 1000)) &&  // if it started < 10 minutes ago
           sesh.startp < (now + (window.lookaheadMinutes * 60 * 1000)) && // and if it starts in < 20 minutes from now
           sesh.endp > now                            // and hsan't ended yet
          ){
          console.log(sesh);
          var html = '<li>'
          html += '<strong>' + sesh.title + '</strong> '
          html += 'â€” <span class="theme">' + sesh.theme + '</span> '
          html += '<br /><span class="details" style="text-align: left;">'
          html += '<span class="time">' + sesh.start.toString().slice(11, 16) +" - " + sesh.end.slice(11, 16) + '</span> '
          html += 'Location: <em>' + sesh.location + '</em>'
          html += ' <a href="http://schedule.mozillafestival.org/#session/' + sesh.id + '">(link)</a>'
          html += '</span>'
          html += '</li>'
          $('ul').append(html)
        }
      }
    }
    window.data = null;
    window.getSked = function(){
      $.ajax({
        dataType: "jsonp",
        jsonpCalback: "jsonp",
        url: url,
        success: function(data){
          window.data = data;
          if (localStorage){
            localStorage.setItem(window.lsKey, JSON.stringify(data));
            console.log('wrote to localstorage')
          }
          window.render();
        }
      });
    }

    $('#rerender').on('click', function(){ window.render(); window.getSked(); });

    $(function(){
      // if(! localStorage.)
      if (localStorage){
        if(localStorage.getItem(window.lsKey)){
          console.log('got from localstorage')
          window.data = JSON.parse(localStorage.getItem(window.lsKey));
          window.render();
          window.getSked();
        }else{
          console.log('not in localstorage')
          window.getSked();
        }
      }else{
        window.getSked();
      }
    });
  </script>
</body>
</html>